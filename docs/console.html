<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="apple-touch-icon" href="static/icons/system.png"/>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<style>
body
{
    background: #efefef;
    color: #000;
    font-family: courier;
    font-size: 105%;
    margin: 1;
    padding-bottom: 10px;
}

a:link 
{
    color: #000;
}

a:visited 
{
    color: #000;
}

a:active 
{
    color: #000;
}

ul
{
    list-style: none;
    margin: 0;
    padding: 0;
}

li
{
    border-top: 1px solid #efefef;
    border-bottom: 1px solid #dfdfdf;
    padding-bottom: 1px;
    padding-left: 55px;
    background-repeat: no-repeat; 
    background-position: 0px 0px; 
    min-height: 60px; 
}

li.head
{
    padding-left: 0px;
    padding: 5px;
    min-height: 16px;
}

input
{
    padding:1px 0;
}

.key
{
    font-weight: bold;
    font-family: sans-serif;
}

.bar
{
    text-align: left;
    min-height: 20px;
    padding: 2px;
    background: #111;
    border-top: 1px solid #333;
    font-size: 14px;
    color: #fff;
    font-weight: 700;
    position: relative; 
    width: 100%;
    z-index: 101!important;
}

.pretty
{
    font-family: 'Proxima Nova Bold',"Calibri","Droid Sans","Helvetica Neue","Helvetica","Arial",sans-serif;
}

.from
{
    font-weight: bold;
}

.options 
{
    position: absolute;
    right: 0px;
}

.panel
{
    padding: 1px; 
    margin: 1px;
}

.button 
{
    padding:10px;
    margin-right:10px;
    background-color: #dcdcdc;
    border: 1px solid #666;
    color:#000;
    text-decoration:none;
}

.when
{
    font-size: 70%;
    color: #909090;
    padding: 10px;
}

.container 
{
    margin: 5px auto;
    position:relative;
    word-wrap: break-word;
}

.private
{
    color: #000;
}

.chat
{
    color: #000;
}

.server
{
    color: #0000ff;
}

.info
{
    font-size: 66%;
    display: none;
    margin: 5px;
}

input.input-box
{ 
    font-size: 18px;
    width: 100%; 
    height: 32px; 
    border: 1px solid #999999; 
    padding: 0px; 
    background: #fff; 
    color: #000;
}
</style>
<meta charset="utf-8"/>
<title></title>
<script>
var qs=function(e){if(e=="")return{};var t={};for(var n=0;n<e.length;++n){var r=e[n].split("=");if(r.length!=2)continue;t[r[0]]=decodeURIComponent(r[1].replace(/\+/g," "))}return t}(window.location.search.substr(1).split("&"))

Date.prototype.stdTimezoneOffset = function() 
{
    var jan = new Date(this.getFullYear(), 0, 1);
    var jul = new Date(this.getFullYear(), 6, 1);
    return Math.max(jan.getTimezoneOffset(), jul.getTimezoneOffset());
}

Date.prototype.dst = function() 
{
    return this.getTimezoneOffset() < this.stdTimezoneOffset();
}

</script>
</head>
<body>
<div class="bar pretty" id="bar">
</div>
<div class="container">
<div class="console">
</div>
</div>  
<script>

var aliases = {};
var icons = {};
var deref, lat, lon, loc;

var entities = 
{
    '"': '&quot;',
    "'": '&#39;',
    "<": "&lt;",
    ">": "&gt;",
    "/": '&#x2F;',
    "&": "&amp;"
};

function escaped (string)
{
    return String(string).replace
    (
        /[";<>\/&]/g, 
        function (s) 
        {
            return entities[s];
        }
    );
}

function render_line (body)
{
    var words = body.split (" ");
    var list = [];
    for (var i = 0; i < words.length; i++)
    {
        var word = words[i];
        if (word.substr (0, 7) == 'http://' || word.substr (0, 8) == 'https://')
        {
            if (deref == undefined)
            {
                list.push ("<a target='_blank' href='" + escaped(word) + "'>" + escaped(word) + "</a>");
            }
            else
            {
                list.push ("<a target='_blank' href='" + deref + escaped(word) + "'>" + escaped(word) + "</a>");
            }
        }
        else
        {
            list.push (escaped(word));
        }
    }
    return list;
}

function decorate_line (when, from, line)
{
    var whom = from;

    if (aliases.hasOwnProperty(from))
    {
        whom = aliases[from];
    }

    if (icons.hasOwnProperty (whom))
    {
        var width = icons[whom]['width'];
        var height = icons[whom]['height'];
        var image = icons[whom]['image'];
        var style = "background-size: " + width + "px " + height + "px; background-image: url(" + image + "); display: block;";
        return "<li style='" + style + "'>" + 
            "<span class='pretty from'>" + (from == '_default' ? 'server:' : from) + "</span>" + 
            "<span class='when options'>" + when + "</span>" + 
            "<br/>" + 
            line + 
            "</li>";
    }

    return "<li><span class='msg chat'>&lt;" + from + "&gt;</span>" + " " + line + " " + "<span class='when options'>" + when + "</span></li>";
}

function decorate_server_message (line)
{
    return decorate_line ('', '_default', line);
}

function prettyprint_date (date)
{
    return _prettyprint_date (date, false);
}

function prettyprint_time (date)
{
    return _prettyprint_date (date, true);
}

function _prettyprint_date (date, flag)
{
    var d = new Date(date*1000);
    d.setTime(d.valueOf() - (60000 * d.getTimezoneOffset()) - (d.dst() ? 60000 * 60 : 0));
    var ds = d.toString();
    var chunks = ds.split (" ");
    return flag ? chunks[4] : ds;
}

function process_chatline (v, i)
{
    var when = prettyprint_time (v['date']);
    var list = render_line (v['body']);
    var msg = v['from'] == '' 
        ? decorate_server_message (v['body'])
        : decorate_line (when, v['from'], list.join (" "));
    msg = msg.replace(/\n/g, "<br />");
    if (v['type'] == 'private')
    {
        msg = '<li><span class="msg private">' + msg + '</span></li>';
    }
    return msg;
}

function getDefaultLimit()
{
    if (screen.availWidth == 320 && screen.availHeight == 548) // iPhone 5
    {
        return 5; // seems about right
    }
    return 10;
}

var max = qs.hasOwnProperty('limit') ? qs['limit'] : getDefaultLimit();

function changeFavIcon (url)
{
    if ($("#favicon").length)
    {
        $("#favicon").attr("href", url);
    }
    else
    {
        $('head').append('<link id="favicon" href="' + url + '" rel="shortcut icon" type="image/x-icon" />');
    }
}

function setup (config)
{
    if (config.hasOwnProperty('title'))
    {
        document.title = config['title'];
    }

    if (config.hasOwnProperty('favicon'))
    {   
        changeFavIcon (config['favicon']);
    }

    if (config.hasOwnProperty('geolocation') && config['geolocation'] == 'enabled' && navigator.geolocation)
    {
        navigator.geolocation.getCurrentPosition (onPositionUpdate);
    }

    if (config.hasOwnProperty('icons'))
    {
        icons = config['icons'];
    }
    
    if (config.hasOwnProperty('aliases'))
    {
        aliases = config['aliases'];
    }

    if (config.hasOwnProperty('deref'))
    {
        deref = config['deref'];
    }

    startup();
}

function startup()
{
    $.ajax
    (
        {
            url: '/get',
            success: function(_data) 
            {
                {
                    var data = jQuery.parseJSON (_data);
                    var idiots = Object.keys(data['state']['whom']).join (", ");

                    var duh = $.map
                    (
                        data['msgs'],
                        process_chatline
                    );

                    while (duh.length > max)
                    {
                        duh.shift();
                    }

                    $('#bar').html (idiots);
                    $('.console').append
                    (
                        "<ul>" + 
                        duh.join ("")  + 
                        "</ul>"
                    );

                    $('#state').html 
                    (
                        pair ("Created", prettyprint_date (data['state']['create_date'])) + "<br/>" + 
                        pair ("Updated", prettyprint_date (data['state']['update_date'])) + "<br/>" + 
                        pair ("Nick", escaped (data['options']['nick'])) + "<br/>" + 
                        pair ("JID", escaped (data['options']['jid'])) + "<br/>" + 
                        pair ("Room", escaped (data['options']['room'])) + "<br/>" + 
                        pair ("Subject", escaped (data['state']['subject'])) + "<br/>" + 
                        pair ("Chatlines", escaped (data['chatlines']))
                    );
                }
            }
        }
    );
}

function pair (key, value)
{
    return "<span class='key'>" + key + ":" + "</span>" + "&nbsp;" + value;
}

</script>

<div class="panel">
<form id="chat" name="chat" action="/put" method="post">
<input class="input-box" size=32 id="line" name="line"/>
<input type="hidden" name="lat" value="0">
<input type="hidden" name="lon" value="0">
<input type="hidden" name="loc" value="">
</form>
<br/>
<div id="buttons">
</div>
</div>

<script>
function onAddressUpdate (data, lat, lon)
{
    loc = data.results[0].formatted_address;
    $('input[name="loc"]').val (loc);
    $.ajax
    (
        {
            url: '/geo?loc=' + loc + '&lat=' + lat + '&lon=' + lon,
            success: function(_data) 
            {
                // console.log ("sent: " + loc + " => " + lat + "," + lon);
            }
        }
    );
}

function onPositionUpdate (position)
{
    lat = position.coords.latitude;
    lon = position.coords.longitude;
    $('input[name="lat"]').val (lat);
    $('input[name="lon"]').val (lon);

    $.ajax
    (
        { 
            url:'http://maps.googleapis.com/maps/api/geocode/json?latlng=' + lat + ',' + lon + '&sensor=true',
            success: function (data)
            {
                onAddressUpdate (data, lat, lon);
            }
        }
    );
}

function showInfo()
{
    if ($('#info').is(":visible"))
    {
        $('#info').hide();
        return;
    }

    $('#geo').html 
    (
        "<span class='key'>Lat/Lon:</span>&nbsp;" + lat + "," + lon + "<br/>" + 
        "<span class='key'>Location:</span>&nbsp;" + loc
    );
    $('#info').show();
}

$(document).ready
(
    function() 
    {
        $("#bar").html ("Loading...");
        $("#line").focus();
        $("#line").select();
        $('#buttons').append ('<a class="button" href="javascript:document.chat.submit()">Go</a>');
        $('#buttons').append ('<a class="button" href="/">Refresh</a>');
        $('#buttons').append ('<a class="button" href="javascript:showInfo()">Info</a>');

        if (! qs.hasOwnProperty('limit'))
        {
            $('#buttons').append ('<a class="button" href="/?limit=50">More</a>');
        }
        else
        {
            $('#buttons').append ('<a class="button" href="/">Less</a>');
        }

        $.ajax
        (
            {
                url: '/config',
                success: function(_data)
                {
                    {
                        var config = jQuery.parseJSON (_data);
                        setup (config);
                    }
                }
            }
        );
    }
);

</script>
<p>
<div class="info" id="info">
<span id="state"></span><br/>
<span id="geo"></span>
</div>
</p>
</body>
</html>
